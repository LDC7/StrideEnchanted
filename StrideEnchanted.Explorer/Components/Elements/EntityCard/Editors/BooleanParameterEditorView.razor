@using System
@using MudBlazor
@using StrideEnchanted.Explorer.Interfaces
@using System.ComponentModel

@implements IDisposable

<MudCheckBox T="bool?"
             @ref="@this.editorRef"
             Label="@this.Parameter.Name"
             Value="@this.internalValue"
             Class="my-1"
             Color="@Color.Primary"
             TriState="@this.isNullable"
             ValueChanged="@this.HandleValueChanged" />

@code {
  private MudCheckBox<bool?> editorRef = default!;
  private bool? internalValue = default;
  private bool isNullable = false;

  [Parameter]
  [EditorRequired]
  public required ITrackedEntityComponentParameter Parameter { get; set; } = default!;

  protected override Task OnInitializedAsync()
  {
    this.isNullable = Nullable.GetUnderlyingType(this.Parameter.ParameterType) != null;
    this.internalValue = this.Parameter.Value as bool?;
    this.Parameter.PropertyChanged += this.OnPropertyChanged;
    return base.OnInitializedAsync();
  }

  private void HandleValueChanged(bool? newValue)
  {
    this.internalValue = newValue;
    this.Parameter.SetValue(this.isNullable ? this.internalValue : (this.internalValue ?? false));
  }

  private void OnPropertyChanged(object? sender, PropertyChangedEventArgs _)
  {
    this.internalValue = this.Parameter.Value as bool?;
    this.InvokeAsync(this.StateHasChanged);
  }

  public void Dispose()
  {
    this.Parameter.PropertyChanged -= this.OnPropertyChanged;
  }
}
